# 通信协议说明文档

## 1. 概述
本文档描述了AGV系统中各板间的CAN通信协议。系统包含多个AGV板（A/B/C/D）和底盘主控，通过CAN总线进行数据交换。

## 2. 硬件配置
- CAN1：用于电机反馈和编码器数据

- CAN2：用于板间通信和接收下发的实际功率，限制功率，期望xy速度

  板间通信：本轮组分为两帧，向外发送本轮组的反馈转速扭矩以及原始pid输出的扭矩

## 3. 通信帧定义

### 3.1 CAN1 通信帧

| 帧ID | 方向 | 说明 | 数据内容 |
|------|------|------|----------|
| 0x201 | 接收 | 转向电机反馈 | 电机状态数据 |
| 0x202 | 接收 | 动力电机反馈 | 电机状态数据 |
| ENCODER_ID | 接收 | 编码器数据 | 编码器状态数据 |

### 3.2 CAN2 通信帧

#### 3.2.1 功率和速度控制帧

| 帧ID | 方向 | 说明 | 数据结构 |
|------|------|------|----------|
| 0x01E | 接收 | 功率数据 | [0-1]: 最大功率限制(uint16_t)<br>[2-5]: 实际功率(float) |
| AGV_BOARD_ID | 接收 | 速度控制 | [0-3]: velocity_x(float)<br>[4-7]: velocity_y(float) |

#### 3.2.2 电机数据反馈帧 (0x02X系列)

| 帧ID | 对应板卡 | 数据内容 |
|------|----------|----------|
| 0x02A | 板A | [0-3]: 转向电机0反馈转速扭矩<br>[4-7]: 动力电机1反馈转速扭矩 |
| 0x02B | 板B | [0-3]: 转向电机2反馈转速扭矩<br>[4-7]: 动力电机3反馈转速扭矩 |
| 0x02C | 板C | [0-3]: 转向电机4反馈转速扭矩<br>[4-7]: 动力电机5反馈转速扭矩 |
| 0x02D | 板D | [0-3]: 转向电机6反馈转速扭矩<br>[4-7]: 动力电机7反馈转速扭矩 |

#### 3.2.3 电机扭矩数据帧 (0x03X系列)

| 帧ID | 对应板卡 | 数据内容 |
|------|----------|----------|
| 0x03A | 板A | [0-1]: 转向电机0pid输出扭矩<br>[2-3]: 动力电机1pid输出扭矩 |
| 0x03B | 板B | [0-1]: 转向电机2pid输出扭矩<br>[2-3]: 动力电机3pid输出扭矩 |
| 0x03C | 板C | [0-1]: 转向电机4pid输出扭矩<br>[2-3]: 动力电机5pid输出扭矩 |
| 0x03D | 板D | [0-1]: 转向电机6pid输出扭矩<br>[2-3]: 动力电机7pid输出扭矩 |

## 4. 数据结构定义

### 4.1 电机功率数据结构

```
typedef struct

{

fp16 feedback_omega; // 反馈的转子转速,rpm

fp16 feedback_torque; // 反馈的转子转矩,Nm

fp16 torque; // pid输出的转子转矩,Nm

float theoretical_power; // 理论功率

float scaled_power; // 功率（收缩后）

int16_t pid_output; // pid输出的扭矩电流控制值（16384）

int16_t output; // 最终输出扭矩电流控制值（16384）

} Struct_Power_Motor_Data;
```

### 4.2 功率管理结构体

```
typedef struct

{

uint16_t Max_Power; // 最大功率限制

float Scale_Conffient; // 功率收缩系数

float Theoretical_Total_Power; // 理论总功率

float Scaled_Total_Power; // 收缩后总功率

float Actual_Power; // 实际总功率

Struct_Power_Motor_Data Motor_Data[8]; // 电机数据数组

} Struct_Power_Management;
```

